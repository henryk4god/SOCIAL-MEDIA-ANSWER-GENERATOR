<div id="answer-widget">
  <style>
    :root {
      --primary-color: #4f46e5;
      --bg-color: #f9fafb;
      --text-color: #111827;
      --card-color: #ffffff;
    }

    #answer-widget {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      padding: 2rem;
      border-radius: 1rem;
      max-width: 800px;
      margin: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    #answer-widget h2 {
      text-align: center;
      margin-bottom: 1rem;
      font-weight: 600;
    }

    #question-input {
      width: 100%;
      padding: 1rem;
      border: 2px solid var(--primary-color);
      border-radius: 0.75rem;
      margin-bottom: 1rem;
      font-size: 1rem;
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      margin-bottom: 1rem;
    }

    .platform-btn, #generate-btn, #copy-btn {
      background-color: var(--primary-color);
      color: white;
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }

    .platform-btn:hover, #generate-btn:hover, #copy-btn:hover {
      background-color: #4338ca;
    }

    #result-container {
      background: var(--card-color);
      padding: 1.5rem;
      border-radius: 1rem;
      margin-top: 1rem;
      box-shadow: 0 2px 12px rgba(0,0,0,0.05);
      white-space: pre-wrap;
      line-height: 1.6;
      display: none;
    }

    .stats-container {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--card-color);
      border-radius: 0.5rem;
      font-size: 0.8rem;
      display: none;
    }

    .loading {
      opacity: 0.7;
      pointer-events: none;
    }

    @media (max-width: 600px) {
      .button-group {
        flex-direction: column;
      }
    }
  </style>

  <h2>ðŸŽ¯ Answer To Your Ask Questions</h2>
  <input id="question-input" placeholder="Enter your question..." />

  <div class="button-group">
    <button id="generate-btn">Get The Answer</button>
    <button class="platform-btn" onclick="formatResult('facebook')">Facebook</button>
    <button class="platform-btn" onclick="formatResult('instagram')">Instagram</button>
    <button class="platform-btn" onclick="formatResult('tiktok')">TikTok</button>
    <button class="platform-btn" onclick="formatResult('youtube')">YouTube</button>
    <button id="copy-btn">ðŸ“‹ Copy</button>
  </div>

  <div id="result-container"></div>

  <div class="stats-container" id="stats-container">
    <strong>Usage Stats:</strong>
    <div id="stats-content"></div>
  </div>

  <script>// ðŸ”§ CONFIGURATION - Use your deployed GAS Web App URL
const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbxwr85XkfWgsjilBVuh7YTeTX5fCIiN_Nlsk9PsliClzskDhk2M2rQ7aeN76bRQvtIL/exec';

let baseContent = "";
let currentPlatform = "original";

// Initialize the widget
document.addEventListener('DOMContentLoaded', function() {
  loadStats();
});

document.getElementById("generate-btn").onclick = async () => {
  const question = document.getElementById("question-input").value.trim();
  if (!question) {
    alert("Please enter a question.");
    return;
  }

  // Show loading state
  const generateBtn = document.getElementById("generate-btn");
  const originalText = generateBtn.textContent;
  generateBtn.textContent = "â³ Generating...";
  generateBtn.classList.add('loading');

  document.getElementById("result-container").textContent = "â³ Generating answer...";
  document.getElementById("result-container").style.display = "block";
  document.getElementById("stats-container").style.display = "none";

  try {
    // ðŸ”¥ UPDATED: Use GET with parameters instead of POST to avoid CORS preflight
    const url = `${BACKEND_URL}?action=generateAnswer&question=${encodeURIComponent(question)}`;
    
    const response = await fetch(url, {
      method: 'GET',
      mode: 'no-cors' // This avoids CORS preflight but limits response reading
    }).catch(async () => {
      // Fallback: Use Google Apps Script as a proxy via JSONP-style callback
      return await fetchViaJSONP(question);
    });

    // If we used no-cors, we can't read the response directly
    // So we'll use a different approach - create a hidden iframe
    if (response && response.type === 'opaque') {
      // The response went through but we can't read it due to CORS
      // Wait a bit and try to get the result via a separate GET request
      setTimeout(() => {
        checkForGeneratedResult(question);
      }, 3000);
    } else {
      const data = await response.json();
      handleResponseData(data);
    }
    
  } catch (err) {
    // ðŸ”¥ FALLBACK: Use JSONP approach for CORS bypass
    try {
      await fetchViaJSONP(question);
    } catch (fallbackError) {
      document.getElementById("result-container").textContent = "âŒ Error: Could not connect to server. Please try again.";
      showError("Connection failed: " + fallbackError.message);
    }
  } finally {
    // Restore button state
    generateBtn.textContent = originalText;
    generateBtn.classList.remove('loading');
  }
};

// ðŸ”¥ NEW: JSONP-style workaround for CORS
function fetchViaJSONP(question) {
  return new Promise((resolve, reject) => {
    const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
    
    // Create script tag
    const script = document.createElement('script');
    const url = `${BACKEND_URL}?action=generateAnswer&question=${encodeURIComponent(question)}&callback=${callbackName}`;
    
    script.src = url;
    script.onerror = reject;
    
    // Define the callback function
    window[callbackName] = function(data) {
      delete window[callbackName];
      document.body.removeChild(script);
      handleResponseData(data);
      resolve(data);
    };
    
    document.body.appendChild(script);
  });
}

// ðŸ”¥ NEW: Handle response data
function handleResponseData(data) {
  if (data.success) {
    baseContent = data.content;
    currentPlatform = "original";
    document.getElementById("result-container").textContent = baseContent;
    showSuccess("Answer generated successfully!");
    loadStats();
  } else {
    document.getElementById("result-container").textContent = "âŒ Error: " + data.error;
    showError(data.error);
  }
}

// ðŸ”¥ NEW: Check for result after submission
function checkForGeneratedResult(question) {
  const checkUrl = `${BACKEND_URL}?action=getLastResult&question=${encodeURIComponent(question)}`;
  
  fetch(checkUrl)
    .then(response => response.json())
    .then(data => {
      if (data.success && data.content) {
        handleResponseData(data);
      } else {
        document.getElementById("result-container").textContent = "âŒ Request submitted but could not retrieve response. Please refresh and try again.";
      }
    })
    .catch(err => {
      console.log('Check result error:', err);
    });
}

// Keep all your other functions the same (formatResult, getPlatformHashtags, copy-btn, loadStats, etc.)
function formatResult(platform) {
  if (!baseContent) {
    alert("Please generate an answer first.");
    return;
  }

  let formattedContent = "";
  currentPlatform = platform;

  switch (platform) {
    case "facebook":
      formattedContent = `ðŸ“˜ FACEBOOK POST\n\n${baseContent}`;
      break;
    
    case "instagram":
      formattedContent = `ðŸ“¸ INSTAGRAM CAPTION\n\n${baseContent}\n\nðŸ”„ Double tap if you found this helpful!\nðŸ’¬ Comment your thoughts below!\nðŸ“± Share with someone who needs this!`;
      break;
    
    case "tiktok":
      const lines = baseContent.split('\n');
      const firstLine = lines[0];
      const restContent = lines.slice(1).join('\n');
      formattedContent = `ðŸŽµ TIKTOK SCRIPT\n\nHOOK: "Stop scrolling! This will change everything... â¬‡ï¸"\n\n${firstLine}\n\n${restContent}\n\nðŸ‘€ Wait for the surprise at the end!\nðŸ’¡ Follow for daily tips!`;
      break;
    
    case "youtube":
      formattedContent = `ðŸŽ¬ YOUTUBE SCRIPT\n\nINTRO: "Hey everyone! Welcome back to the channel. Today we're diving into a question I get asked ALL the time..."\n\nMAIN CONTENT:\n${baseContent}\n\nOUTRO: "If you found this helpful, smash that like button and subscribe for more content like this every week!"`;
      break;
    
    default:
      formattedContent = baseContent;
  }

  const hashtags = getPlatformHashtags(platform);
  formattedContent += `\n\n${hashtags}`;

  document.getElementById("result-container").textContent = formattedContent;
  showSuccess(`Formatted for ${platform.charAt(0).toUpperCase() + platform.slice(1)}!`);
}

function getPlatformHashtags(platform) {
  const baseHashtags = "#SocialMediaTips #ContentCreation #DigitalMarketing";
  
  switch (platform) {
    case "facebook":
      return `${baseHashtags} #FacebookMarketing #SocialMediaStrategy`;
    case "instagram":
      return `${baseHashtags} #InstagramTips #InstaGrowth #ContentCreator`;
    case "tiktok":
      return `${baseHashtags} #TikTokTips #ViralContent #ForYouPage`;
    case "youtube":
      return `${baseHashtags} #YouTubeTips #VideoMarketing #CreatorEconomy`;
    default:
      return baseHashtags;
  }
}

document.getElementById("copy-btn").onclick = async () => {
  const text = document.getElementById("result-container").textContent;
  if (!text || text === "â³ Generating answer...") {
    alert("Nothing to copy. Please generate an answer first.");
    return;
  }

  try {
    await navigator.clipboard.writeText(text);
    showSuccess("Copied to clipboard! ðŸ“‹");
  } catch (err) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand("copy");
    document.body.removeChild(textArea);
    showSuccess("Copied to clipboard! ðŸ“‹");
  }
};

async function loadStats() {
  try {
    const response = await fetch(`${BACKEND_URL}?action=getStats`);
    const data = await response.json();
    
    if (data.success) {
      const stats = data.stats;
      const statsContent = `
        Today: ${stats.todayRequests}/${stats.dailyLimit} requests
        | Success Rate: ${stats.successRate}%
        | Total: ${stats.totalRequests} requests
      `;
      document.getElementById("stats-content").textContent = statsContent;
      document.getElementById("stats-container").style.display = 'block';
    }
  } catch (err) {
    console.log('Could not load stats:', err);
  }
}

function showSuccess(message) {
  const originalText = document.getElementById("copy-btn").textContent;
  document.getElementById("copy-btn").textContent = "âœ… " + message;
  setTimeout(() => {
    document.getElementById("copy-btn").textContent = originalText;
  }, 2000);
}

function showError(message) {
  alert("Error: " + message);
}

// Keyboard shortcut support
document.getElementById("question-input").addEventListener("keypress", function(e) {
  if (e.key === "Enter") {
    document.getElementById("generate-btn").click();
  }
});

// Auto-resize input based on content
document.getElementById("question-input").addEventListener("input", function() {
  this.style.height = "auto";
  this.style.height = (this.scrollHeight) + "px";
});
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
</div>
