<div id="answer-widget">
  <style>
    :root {
      --primary-color: #4f46e5;
      --bg-color: #f9fafb;
      --text-color: #111827;
      --card-color: #ffffff;
    }

    #answer-widget {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      padding: 2rem;
      border-radius: 1rem;
      max-width: 800px;
      margin: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    #answer-widget h2 {
      text-align: center;
      margin-bottom: 1rem;
      font-weight: 600;
    }

    #question-input {
      width: 100%;
      padding: 1rem;
      border: 2px solid var(--primary-color);
      border-radius: 0.75rem;
      margin-bottom: 1rem;
      font-size: 1rem;
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      margin-bottom: 1rem;
    }

    .platform-btn, #generate-btn, #copy-btn {
      background-color: var(--primary-color);
      color: white;
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }

    .platform-btn:hover, #generate-btn:hover, #copy-btn:hover {
      background-color: #4338ca;
    }

    #result-container {
      background: var(--card-color);
      padding: 1.5rem;
      border-radius: 1rem;
      margin-top: 1rem;
      box-shadow: 0 2px 12px rgba(0,0,0,0.05);
      white-space: pre-wrap;
      line-height: 1.6;
      display: none;
    }

    .stats-container {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--card-color);
      border-radius: 0.5rem;
      font-size: 0.8rem;
      display: none;
    }

    .loading {
      opacity: 0.7;
      pointer-events: none;
    }

    @media (max-width: 600px) {
      .button-group {
        flex-direction: column;
      }
    }
  </style>

  <h2>üéØ Answer To Your Ask Questions</h2>
  <input id="question-input" placeholder="Enter your question..." />

  <div class="button-group">
    <button id="generate-btn">Get The Answer</button>
    <button class="platform-btn" onclick="formatResult('facebook')">Facebook</button>
    <button class="platform-btn" onclick="formatResult('instagram')">Instagram</button>
    <button class="platform-btn" onclick="formatResult('tiktok')">TikTok</button>
    <button class="platform-btn" onclick="formatResult('youtube')">YouTube</button>
    <button id="copy-btn">üìã Copy</button>
  </div>

  <div id="result-container"></div>

  <div class="stats-container" id="stats-container">
    <strong>Usage Stats:</strong>
    <div id="stats-content"></div>
  </div>

  <script>
    // üîß CONFIGURATION - Use your deployed GAS Web App URL
const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbwWk-poZRQwr1I4-1yl1slwNjz0MfjqvSF3kcr5VTrsD6Nc7D7i8PRhw36R8aCMHGtv/exec';

let baseContent = "";
let currentPlatform = "original";

document.getElementById("generate-btn").onclick = async () => {
  const question = document.getElementById("question-input").value.trim();
  if (!question) {
    alert("Please enter a question.");
    return;
  }

  // Show loading state
  const generateBtn = document.getElementById("generate-btn");
  const originalText = generateBtn.textContent;
  generateBtn.textContent = "‚è≥ Generating...";
  generateBtn.disabled = true;

  document.getElementById("result-container").textContent = "‚è≥ Generating answer...";
  document.getElementById("result-container").style.display = "block";
  document.getElementById("stats-container").style.display = "none";

  try {
    // üî• SIMPLIFIED: Use direct fetch with error handling
    const response = await fetchWithRetry(question);
    
    if (response.success) {
      baseContent = response.content;
      currentPlatform = "original";
      document.getElementById("result-container").textContent = baseContent;
      showSuccess("Answer generated successfully!");
      loadStats();
    } else {
      document.getElementById("result-container").textContent = "‚ùå Error: " + response.error;
      showError(response.error);
    }
    
  } catch (err) {
    document.getElementById("result-container").textContent = "‚ùå Connection Error: Please check your internet and try again.";
    showError("Connection failed: " + err.message);
  } finally {
    // Restore button state
    generateBtn.textContent = originalText;
    generateBtn.disabled = false;
  }
};

// üî• NEW: Simple fetch with retry logic
async function fetchWithRetry(question, retries = 3) {
  for (let i = 0; i < retries; i++) {
    try {
      // Try JSONP first (best for CORS)
      try {
        return await fetchViaJSONP(question);
      } catch (jsonpError) {
        console.log('JSONP failed, trying direct fetch:', jsonpError);
      }
      
      // Fallback to direct fetch
      const url = `${BACKEND_URL}?action=generateAnswer&question=${encodeURIComponent(question)}`;
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      if (response.ok) {
        const data = await response.json();
        return data;
      }
    } catch (error) {
      console.log(`Attempt ${i + 1} failed:`, error);
      if (i === retries - 1) throw error;
      // Wait before retry (exponential backoff)
      await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
    }
  }
  throw new Error('All retry attempts failed');
}

// üî• UPDATED: Better JSONP implementation
function fetchViaJSONP(question) {
  return new Promise((resolve, reject) => {
    const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
    const timeoutId = setTimeout(() => {
      delete window[callbackName];
      reject(new Error('JSONP timeout'));
    }, 15000); // 15 second timeout
    
    window[callbackName] = function(data) {
      clearTimeout(timeoutId);
      delete window[callbackName];
      document.body.removeChild(script);
      resolve(data);
    };
    
    const script = document.createElement('script');
    const url = `${BACKEND_URL}?action=generateAnswer&question=${encodeURIComponent(question)}&callback=${callbackName}`;
    script.src = url;
    script.onerror = () => {
      clearTimeout(timeoutId);
      delete window[callbackName];
      reject(new Error('JSONP script failed to load'));
    };
    
    document.body.appendChild(script);
  });
}

// üî• NEW: Simple direct POST approach (might work with CORS headers)
async function fetchDirect(question) {
  const response = await fetch(BACKEND_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      action: 'generateAnswer',
      question: question
    })
  });
  
  if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
  }
  
  return await response.json();
}

// Keep all your other functions exactly the same
function formatResult(platform) {
  if (!baseContent) {
    alert("Please generate an answer first.");
    return;
  }

  let formattedContent = "";
  currentPlatform = platform;

  switch (platform) {
    case "facebook":
      formattedContent = `üìò FACEBOOK POST\n\n${baseContent}`;
      break;
    
    case "instagram":
      formattedContent = `üì∏ INSTAGRAM CAPTION\n\n${baseContent}`;
      break;
    
    case "tiktok":
      formattedContent = `üéµ TIKTOK\n\n${baseContent}`;
      break;
    
    case "youtube":
      formattedContent = `üé¨ YOUTUBE\n\n${baseContent}`;
      break;
    
    default:
      formattedContent = baseContent;
  }

  document.getElementById("result-container").textContent = formattedContent;
  showSuccess(`Formatted for ${platform.toUpperCase()}!`);
}

document.getElementById("copy-btn").onclick = async () => {
  const text = document.getElementById("result-container").textContent;
  if (!text || text.includes("‚è≥ Generating") || text.includes("‚ùå Error")) {
    alert("Nothing to copy. Please generate an answer first.");
    return;
  }

  try {
    await navigator.clipboard.writeText(text);
    showSuccess("Copied to clipboard! üìã");
  } catch (err) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand("copy");
    document.body.removeChild(textArea);
    showSuccess("Copied to clipboard! üìã");
  }
};

async function loadStats() {
  try {
    const url = `${BACKEND_URL}?action=getStats&callback=jsonp_callback_stats`;
    const script = document.createElement('script');
    script.src = url;
    document.body.appendChild(script);
  } catch (err) {
    console.log('Could not load stats:', err);
  }
}

// Stats callback (must be global)
window.jsonp_callback_stats = function(data) {
  if (data.success) {
    const stats = data.stats;
    const statsContent = `Today: ${stats.todayRequests}/${stats.dailyLimit} requests | Success: ${stats.successRate}%`;
    document.getElementById("stats-content").textContent = statsContent;
    document.getElementById("stats-container").style.display = 'block';
  }
};

function showSuccess(message) {
  const btn = document.getElementById("generate-btn");
  const originalText = btn.textContent;
  btn.textContent = "‚úÖ " + message;
  setTimeout(() => {
    btn.textContent = originalText;
  }, 2000);
}

function showError(message) {
  alert("Error: " + message);
}

// Keyboard support
document.getElementById("question-input").addEventListener("keypress", function(e) {
  if (e.key === "Enter") {
    document.getElementById("generate-btn").click();
  }
});
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
</div>
